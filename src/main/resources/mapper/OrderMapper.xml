<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.flab.makedel.mapper.OrderMapper">

    <insert id="insertOrder" parameterType="com.flab.makedel.dto.OrderDTO" useGeneratedKeys="true"
        keyProperty="id">
        INSERT INTO `ORDER`(order_status, address, user_id, store_id)
        VALUES(#{orderStatus}, #{address}, #{userId}, #{storeId})
    </insert>

    <update id="completeOrder">
        UPDATE `ORDER` SET total_price = #{totalPrice},
        order_status = #{orderStatus}
        where id = #{orderId}
    </update>

    <resultMap type="com.flab.makedel.dto.OrderDetailDTO" id="orderDetail">
        <constructor>
            <idArg column="orderId" javaType="Long"/>
            <arg column="orderStatus" javaType="String"/>
            <arg column="userId" javaType="String"/>
            <arg column="totalPrice" javaType="Long"/>
        </constructor>
        <id property="orderId" column="orderId"/>
        <result property="orderStatus" column="orderStatus"/>
        <result property="userId" column="userId"/>
        <result property="totalPrice" column="totalPrice"/>
        <collection property="storeInfo" ofType="com.flab.makedel.dto.StoreInfoDTO">
            <id property="storeId" column="storeId"/>
            <result property="name" column="storeName"/>
            <result property="phone" column="storePhone"/>
            <result property="address" column="storeAddress"/>
        </collection>
        <collection property="menuList" ofType="com.flab.makedel.dto.OrderDetailMenuDTO">
            <constructor>
                <idArg column="menuId" javaType="Long"/>
                <arg column="menuName" javaType="String"/>
                <arg column="menuPrice" javaType="Long"/>
                <arg column="menuCount" javaType="Long"/>
            </constructor>
            <id property="menuId" column="menuId"/>
            <result property="menuName" column="menuName"/>
            <result property="menuPrice" column="menuPrice"/>
            <result property="menuCount" column="menuCount"/>
            <collection property="optionList" ofType="com.flab.makedel.dto.OrderDetailOptionDTO">
                <constructor>
                    <idArg column="optionId" javaType="Long"/>
                    <arg column="optionName" javaType="String"/>
                    <arg column="optionPrice" javaType="Long"/>
                </constructor>
                <id property="optionId" column="optionId"/>
                <result property="optionName" column="optionName"/>
                <result property="optionPrice" column="optionPrice"/>
            </collection>
        </collection>
    </resultMap>

    <select id="selectDetailOrder" resultMap="orderDetail">
        select
        ord.id as orderId,
        ord.order_status as orderStatus,
        ord.user_id as userId,
        ord.total_price as totalPrice,
        ord.store_id as storeId,
        store.name as storeName,
        store.address as storeAddress,
        store.phone as storePhone,
        m.id as menuId,
        m.name as menuName,
        m.price as menuPrice,
        ord_m.count as menuCount,
        ord_m_o.option_id as optionId,
        m_o.name as optionName,
        m_o.price as optionPrice

        from `order` ord
        join order_menu ord_m on ord.id = ord_m.order_id
        join menu m on ord_m.menu_id = m.id
        join order_menu_option ord_m_o on ord_m.order_id = ord_m_o.order_id
        join menu_option m_o on m_o.id = ord_m_o.option_id
        join pay on ord.id =pay.order_id
        join store on ord.store_id = store.id
        where ord.id = #{orderId};
    </select>

</mapper>
